<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset='utf-8'/>
    <script defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5xt-0-bficSVL6EP57aQseXSiPx8bx7E&callback=initMap&libraries=&&libraries=geometry&libraries=places"></script>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://code.jquery.com/ui/1.12.1/jquery-ui.js'></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- SweetAlert CDN 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        let detailData = [];
        let attractionData = [];
        var markerMake = 0;
        var countMarker = 0;
        var iconMarker;

        document.addEventListener('DOMContentLoaded', function () {


            window.captureMap = function () {
                setTimeout(function () {
                    const mapContainer = document.getElementById("map-container");

                    html2canvas(mapContainer, { useCORS: true }).then(function (canvas) {
                        const imageDataURL = canvas.toDataURL("image/png");

                        const urlParams = new URLSearchParams(window.location.search);
                        const planId = urlParams.get('planId');

                        if (imageDataURL !== null && planId !== null) {
                            const dataToSend = {
                                imageDataURL: imageDataURL,
                                planId: planId
                            };

                            fetch('/plan/saveImage', {
                                method: 'POST',
                                body: JSON.stringify(dataToSend),
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                            }).then(response => response.json())
                                .then(data => {
                                    // 서버 응답 처리
                                });
                        } else {
                            console.error("imageDataURL 또는 planId가 null입니다.");
                        }
                    });
                }, 1500);// 밀리초
            };


            /******************************************************************************************
             Controller -> Html -> Js 로 받아온 정보의 사용
             Html에서 Js로 받아올 경우 String으로 변환되어 온다.
             Controller에서 JSON형식으로 변환하여 전송해 JS에서 String으로 받아온 정보를 JSON타입으로 변환하여 사용한다.
             ******************************************************************************************/
            var detailIdMax = document.getElementById('detailIdMax').getAttribute('data-variable');
            var planID = document.getElementById('planID').getAttribute('data-variable');
            var startDate = document.getElementById('startDate').getAttribute('data-variable');

            /* 계획 생성 시 사용할 ID값 (다음으로 사용될 DetailPlan PK 값을 가져온다) */
            let currentEventId = parseInt(detailIdMax) + 1;
            /* INSERT문이 작동될 때(계획을 생성할 때) +1 */
            function generateEventId() {
                return String(currentEventId++);
            }


            // updateMap(detailData);
        });

        window.initMap = function () {

            const bounds = new google.maps.LatLngBounds();
            const infoWindow = new google.maps.InfoWindow();
            const markers = [];
            const attracionMarkers = [];

            var detailList = document.getElementById('detailList').getAttribute('data-variable');

            var jsonDetailList = JSON.parse(detailList);

            var attractionList = document.getElementById('attractionList').getAttribute('data-variable');
            // JSON 타입으로 변환한다. (String의 형식이 JSON형식이여야지 가능하다.)
            var jsonAttractionList = JSON.parse(attractionList);


            /* 관광지를 선택하지 않았을 경우를 대비하기 위해서 임의로 작성 */
            attractionData.push({
                touristAttractionId : 0,
                address : '',
                name : '선택하지 않음',
                imageUrl : 'https://github.com/hwet-j/rego/assets/125880480/20c539ee-6568-468e-919d-3ed42cb6c56a',
                introduction : '',
                latitude : '',
                longitude : '',
                contentType : '',
                cityName : ''
            });


            /* 관광지 정보를 관광지ID 값으로 검색하기 위해 객체 생성 - 관광지 목록 변수에 저장 */
            jsonAttractionList.forEach(function (attraction) {
                attractionData.push({
                    touristAttractionId : attraction.touristAttractionId.toString(),
                    address : attraction.address.toString(),
                    name : attraction.name.toString(),
                    imageUrl : attraction.image.toString(),
                    introduction : attraction.introduction.toString(),
                    latitude : parseFloat(attraction.latitude),
                    longitude : parseFloat(attraction.longitude),
                    contentType : attraction.contentType.toString(),
                    cityName : attraction.cityName.toString()
                });
            });
            /* DB에 있는 정보를 캘린더에 출력하기 위한 객체 - 상세 일정 변수에 저장 */
            jsonDetailList.forEach(function (detail) {
                const attraction = attractionData.find(attraction => attraction.touristAttractionId == detail.touristAttractionId);

                if (attraction){
                    detailData.push({
                        id:detail.detailPlanId,
                        title: detail.content.toString(),
                        start: detail.startTime,
                        end: detail.endTime,
                        allDay: detail.allDay,
                        touristAttractionId:detail.touristAttractionId,

                        label: detail.touristAttractionId.toString(),
                        name: attraction.name,
                        lat: parseFloat(attraction.latitude),                 // 위도 (실수 형태로 변환필요)
                        lng: parseFloat(attraction.longitude),                // 경도 (실수 형태로 변환필요)
                        imageUrl: attraction.imageUrl.toString(),             // 이미지 경로
                        address: attraction.address.toString(),               // 주소
                        introduction: attraction.introduction.toString()      // 소개글
                    });
                } else {
                    detailData.push({
                        id: detail.detailPlanId,
                        title: detail.content.toString(),
                        start: detail.startTime,
                        end: detail.endTime,
                        allDay: detail.allDay,
                        touristAttractionId: detail.touristAttractionId,
                    });
                }
            });

            detailData.sort(function(a, b) {
                return new Date(a.start) - new Date(b.start);
            });


            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 37.58667, lng: 126.97611 },
                zoom: 12,
                minZoom: 3,
                maxZoom: 30,
                mapTypeControl: false,
                fullscreenControl:false,
            });

            // console.log("지도지도지도");
            updateMap(detailData);

            // 관광지 정보 마커 표시
            attractionMarker(attractionData);

            const attdata = detailData.filter(item => typeof item.lat === 'number' && typeof item.lng === 'number' && !isNaN(item.lat));

            var boundss = new google.maps.LatLngBounds();
            for(var i=0; i < attdata.length; i++){
                boundss.extend(new google.maps.LatLng(attdata[i].lat, attdata[i].lng));
            }
            console.log(attdata);
            map.fitBounds(boundss);

            function updateMap(originDetailData) {
                // 이전 마커 및 선 삭제 로직 (생략)
                markers.forEach(({ marker }) => {
                    marker.setMap(null);
                });
                countMarker = 0;
                const data = originDetailData.filter(item => typeof item.lat === 'number' && typeof item.lng === 'number' && !isNaN(item.lat));

                // console.log(data);

                /* 빨강색 마커 생성하기 위한 작업 */
                data.forEach(({ label, name, lat, lng, imageUrl, introduction , title}) => {

                    countMarker += 1;

                    const marker = new google.maps.Marker({
                        position: { lat, lng },
                        label:'-',
                        map,
                        icon: {
                            url:'https://github.com/hwet-j/hwet-j.github.io/assets/81364742/8e20af8c-7f20-4d3e-a850-7056800236ad',
                            scaledSize: new google.maps.Size(40, 40),
                        },
                        zIndex:1000,
                    });

                    bounds.extend(marker.position);

                    marker.addListener('click', () => {
                        map.panTo(marker.position);

                        const content = document.createElement('div');

                        const image = document.createElement('img');
                        image.src = imageUrl;
                        image.alt = name;
                        image.width = 200;
                        content.appendChild(image);

                        console.log(title);

                        const subject = document.createElement('p');
                        subject.textContent = name;
                        content.appendChild(subject);

                        const title_p = document.createElement('p');
                        title_p.textContent = title;
                        content.appendChild(title_p);


                        const button = document.createElement('button');
                        button.textContent = '관광지정보';
                        button.addEventListener('click', () => {
                            Swal.fire({
                                title: `${name}`,
                                text: `${introduction}`,
                                imageUrl: `${imageUrl}`,
                                imageWidth: 1000,
                                imageHeight: 600,
                                customClass: {
                                    popup: 'custom-modal-width',
                                },
                            });
                        });
                        content.appendChild(button);

                        infoWindow.setContent(content);
                        infoWindow.open(map, marker);

                    });

                    markers.push({ label, name, marker });
                });


                map.fitBounds(bounds);

                // 선 그리기 함수 호출

                drawPolyline(map, data);

                function drawPolyline(map, originDetailData) {

                    const data = originDetailData.filter(item => typeof item.lat === 'number' && typeof item.lng === 'number' && !isNaN(item.lat));

                    /* 아이콘은 최초 1회만 생성되어야 하므로 최초생성 시 0에서 1로변환 */
                    if (markerMake == 0 && countMarker > 1) {
                        markerMake = 1;

                        /* 아이콘 생성 */
                        iconMarker = new google.maps.Marker({
                            map: map,
                            animation: google.maps.Animation.BOUNCE,
                            icon: {
                                url: "https://github.com/hwet-j/hwet-j.github.io/assets/81364742/ef2f4530-9c23-4b1c-aae7-8054e46bd2a7",
                                scaledSize: new google.maps.Size(40, 40),
                                origin: new google.maps.Point(0, 0),
                                anchor: new google.maps.Point(15, 15)
                            }
                        });

                        var index = 0;                 // 마커의 위치
                        var distanceToTravel = 0.001;    // 고정된 이동 거리
                        var speed = 30;                 // 마커 이동 속도

                        /* 아이콘이 움직이는 동작을 구현 */
                        function moveMarker() {

                            if (index < data.length - 1) {
                                var start = data[index];
                                var end = data[index + 1];

                                var latDiff = end.lat - start.lat;
                                var lngDiff = end.lng - start.lng;
                                var totalDistance = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);

                                var fraction = 0;
                                var numSteps = totalDistance / distanceToTravel;

                                var latStep = latDiff / numSteps;
                                var lngStep = lngDiff / numSteps;

                                if (fraction === 0) {
                                    // 방향전환
                                    if (start.lng < end.lng) {
                                        // 좌측에서 우측으로
                                        initialIconUrl = "https://github-production-user-asset-6210df.s3.amazonaws.com/81364742/269530380-4c8c756c-bb05-447a-83dc-bf6464a2fc92.gif";
                                    } else {
                                        // 우측에서 좌측으로
                                        initialIconUrl = "https://github.com/hwet-j/hwet-j.github.io/assets/81364742/ef2f4530-9c23-4b1c-aae7-8054e46bd2a7";
                                    }

                                    var initialIcon = {
                                        url: initialIconUrl,
                                        scaledSize: new google.maps.Size(40, 40),
                                        origin: new google.maps.Point(0, 0),
                                        anchor: new google.maps.Point(15, 15)
                                    };
                                    iconMarker.setIcon(initialIcon);
                                }

                                var move = function () {
                                    fraction += 1;
                                    if (fraction <= numSteps) {
                                        var lat = start.lat + latStep * fraction;
                                        var lng = start.lng + lngStep * fraction;
                                        iconMarker.setPosition({ lat: lat, lng: lng });
                                        setTimeout(move, speed);
                                    } else {
                                        index++;
                                        if (index >= data.length - 1) {
                                            index = 0;  // 1부터 다시 시작
                                        }
                                        moveMarker(index);
                                    }
                                };

                                move();
                            }
                        }

                        moveMarker();

                        /* 화살표 형식으로 선긋기 */
                        for (var i = 0; i < data.length - 1; i++) {
                            var start = data[i];
                            var end = data[i + 1];

                            var lineSymbol = {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, // 화살표 모양
                                scale: 3,               // 화살표 크기
                                strokeColor: "#9900ff" // 화살표의 색상
                            };


                            /* 이 기능을 활용하면 이동방식에 따른 항공,기차 등을 구현 가능할듯함 */
                            var line = new google.maps.Polyline({
                                path: [start, end],
                                icons: [
                                    {
                                        icon: lineSymbol,
                                        offset: "100%" // 화살표 위치 (끝)
                                    }
                                ],
                                strokeColor: "#002aff", // 선의 색상
                                strokeOpacity: 1.0,     // 선의 불투명도 (0.0 - 1.0)
                                strokeWeight: 2,        // 선의 두께
                                map: map
                            });

                            previousPolylines.push(line);

                        }


                    } else if (countMarker > 1){
                        clearPreviousPolylines();

                        for (var i = 0; i < data.length - 1; i++) {
                            var start = data[i];
                            var end = data[i + 1];

                            var lineSymbol = {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, // 화살표 모양
                                scale: 3, // 화살표 크기
                                strokeColor: "#9900ff" // 화살표의 색상
                            };


                            /* 이 기능을 활용하면 이동방식에 따른 항공,기차 등을 구현 가능할듯함 */
                            var line = new google.maps.Polyline({
                                path: [start, end],
                                icons: [
                                    {
                                        icon: lineSymbol,
                                        offset: "100%" // 화살표 위치 (끝)
                                    }
                                ],
                                strokeColor: "#002aff", // 선의 색상
                                strokeOpacity: 1.0,     // 선의 불투명도 (0.0 - 1.0)
                                strokeWeight: 2,        // 선의 두께
                                map: map
                            });

                            previousPolylines.push(line);
                        }

                    } else {
                        clearPreviousPolylines();
                        if (iconMarker){
                            if (countMarker != 0){
                                iconMarker.setMap(null);
                            }
                        }

                        markerMake = 0;
                    }


                }

                var boundss = new google.maps.LatLngBounds();
                for(var i=0; i < data.length; i++){
                    boundss.extend(new google.maps.LatLng(data[i].lat, data[i].lng));
                }
                map.fitBounds(boundss);
            }

            function attractionMarker(attractionOriginData) {
                // 이전 마커 및 선 삭제 로직 (생략)
                attracionMarkers.forEach(({ atmarker }) => {
                    atmarker.setMap(null);
                });

                // console.log(attractionOriginData);

                const atdata = attractionOriginData.filter(item => typeof item.latitude === 'number' && typeof item.longitude === 'number' && !isNaN(item.latitude));
                //console.log(atdata);
                /* 빨강색 마커 생성하기 위한 작업 */
                atdata.forEach(({ touristAttractionId, name, latitude, longitude, imageUrl, introduction }) => {

                    // console.log(touristAttractionId, name, latitude, longitude, imageUrl, introduction)

                    const atmarker = new google.maps.Marker({
                        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
                        // label:'관',
                        map:map,
                        icon: {
                            url: 'https://github.com/hwet-j/hwet-j.github.io/assets/81364742/5d381fdd-ed36-48ff-9cfa-58b1536d5d49',
                            scaledSize: new google.maps.Size(22, 22), // 아이콘 크기 설정
                        },
                        zIndex:10,
                    });

                    bounds.extend(atmarker.position);

                    atmarker.addListener('click', () => {
                        map.panTo(atmarker.position);

                        const content = document.createElement('div');

                        const image = document.createElement('img');
                        image.src = imageUrl;
                        image.alt = name;
                        image.width = 200;
                        content.appendChild(image);

                        const title = document.createElement('p');
                        title.textContent = name;
                        content.appendChild(title);

                        const button = document.createElement('button');
                        button.textContent = '관광지정보';
                        button.addEventListener('click', () => {
                            Swal.fire({
                                title: `${name}`,
                                text: `${introduction}`,
                                imageUrl: `${imageUrl}`,
                                imageWidth: 1000,
                                imageHeight: 600,
                                customClass: {
                                    popup: 'custom-modal-width',
                                },
                            });
                        });
                        content.appendChild(button);

                        infoWindow.setContent(content);
                        infoWindow.open(map, atmarker);
                    });

                    attracionMarkers.push({ touristAttractionId, name, atmarker });
                });


                map.fitBounds(bounds);


            /* updateMap를 전역변수로 변경 */
            window.updateMap = updateMap;
            window.attractionMarker = attractionMarker;

        };
}
        var previousPolylines = [];

        // 이전 선을 모두 제거하는 함수를 정의합니다.
        function clearPreviousPolylines() {
            previousPolylines.forEach(function (polyline) {
                polyline.setMap(null);          // 이전 선을 지도에서 제거
            });
            previousPolylines = []; // 배열 초기화
        }

    </script>

    <style>
        /* SweetAlert창 크기 */
        .custom-modal-width {
            width: 1000px;
        }

       html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

#map {
  width: 70%;
  height: 100%;
  float: left;
}
#other-content {
  width: 30%; /* 다른 콘텐츠의 너비 조절 */
  height: 100%; /* 맵과 동일한 높이로 설정 */
  float: right; /* 왼쪽으로 띄우기 (맵 왼쪽에 배치) */
  /* 다른 스타일 속성 추가 */
}

        /* 알림창 내용 input 태그  */
        #event-title {
            width: 80%;
            padding: 5px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div id="detailList" th:data-variable="${detailPlan}"></div>
<div id="attractionList" th:data-variable="${attractionList}"></div>
<div id="detailIdMax" th:data-variable="${detailIdMax}"></div>
<div id="planID" th:data-variable="${planID}"></div>
<div id="startDate" th:data-variable="${startDate}"></div>


<div id="map"></div>
<div id="other-content">
<div>
    루트수정
</div>
    <div>
            <div th:each="detail : ${detailPlan}"
                    th:text="${detail}"
                    th:value="${detail}">
            </div>
    </div>
</div>


</body>
</html>
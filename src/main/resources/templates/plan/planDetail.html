<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset='utf-8'/>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="/css/plan_detail.css" rel="stylesheet">

    <script defer th:inline="javascript" th:src="@{/index.global2.js}" type="text/javascript"></script>
    <script defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5xt-0-bficSVL6EP57aQseXSiPx8bx7E&callback=initMap&libraries=&&libraries=geometry&libraries=places"></script>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://code.jquery.com/ui/1.12.1/jquery-ui.js'></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- SweetAlert CDN 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        let detailData = [];
        let attractionData = [];
        var markerMake = 0;
        var countMarker = 0;
        var iconMarker;

        document.addEventListener('DOMContentLoaded', function () {

            var calendarEl = document.getElementById('calendar');

            /******************************************************************************************
             Controller -> Html -> Js 로 받아온 정보의 사용
             Html에서 Js로 받아올 경우 String으로 변환되어 온다.
             Controller에서 JSON형식으로 변환하여 전송해 JS에서 String으로 받아온 정보를 JSON타입으로 변환하여 사용한다.
             ******************************************************************************************/
            var detailIdMax = document.getElementById('detailIdMax').getAttribute('data-variable');
            var planID = document.getElementById('planID').getAttribute('data-variable');
            var startDate = document.getElementById('startDate').getAttribute('data-variable');

            /* 계획 생성 시 사용할 ID값 (다음으로 사용될 DetailPlan PK 값을 가져온다) */
            let currentEventId = parseInt(detailIdMax) + 1;
            /* INSERT문이 작동될 때(계획을 생성할 때) +1 */
            function generateEventId() {
                return String(currentEventId++);
            }

            /****************/
            /* 초기 날짜 설정 */
            /****************/
            var today = new Date();

            /*************/
            /* 캘린더 설정 */
            /*************/
            var calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                initialDate: startDate,                 // 초기 날짜 지정
                eventColor : '#b263ff',             // 이벤트 색상
                // eventBorderColor : '#5c6a96',       // 이벤트 테두리 색상
                navLinks: true,
                selectable: true,
                selectMirror: true,
                select: function (arg) {
                    Swal.fire({
                        title: '일정 관리',
                        html: `
                            <div id="image-preview">
                                <img src="/pictures/base.jpg" alt="Selected Image" class="modal-image" onerror="this.src='/pictures/base.jpg';">
                            </div>
                            ${getSelectOptions(attractionData)}
                            <div>
                                <span class="swal2-text-area">메모</span>
                                <span>
                                    <input id="event-title" class="swal2-input"  placeholder="계획을 입력하세요."/>
                                </span>
                            </div>
                            <div>
                                 <span class="swal2-text-area">비용</span>
                                 <span>
                                    <input id="event-price" class="swal2-input" type="number" placeholder="예상 금액을 입력해주세요."/>
                                 </span>
                            </div>
                        `,
                        showCancelButton: true,
                        showCloseButton: true,
                        confirmButtonText: '추가',
                        cancelButtonText: '취소',
                        customClass: {
                            popup: 'custom-modal-width',        // 팝업창의 크기를 조절하기 위한 설정(HTML파일에서 Style설정도 해야함)
                        },
                        didOpen: () => {            // ??
                            const eventTypeSelect = document.getElementById('event-type');
                            const selectedImage = document.getElementById('selected-image');

                            /*eventTypeSelect.addEventListener('change', function () {
                                const selectedValue = eventTypeSelect.value;
                                const selectedAttraction = attractionData.find((attraction) => attraction.touristAttractionId === selectedValue);

                                if (selectedAttraction) {
                                    selectedImage.src = selectedAttraction.imageUrl;
                                } else {
                                    selectedImage.src = '/pictures/base.jpg';       // 선택된 이미지가 없을 경우 기본 이미지 표시
                                }
                            });*/
                        },
                        preConfirm: () => {         // 확인(수정) 버튼을 눌렀을 때 설정할 작업
                            const eventTitle = document.getElementById('event-title').value;
                            const newEventPrice = document.getElementById('event-price').value;
                            const eventType = document.getElementById('event-type').value;
                            const selectedAttraction = attractionData.find((attraction) => attraction.touristAttractionId === eventType);

                            if (!eventTitle) {      // 계획 내용은 필요
                                Swal.showValidationMessage('계획 정보가 입력되지 않았습니다.');
                            } else {
                                var newId = generateEventId();
                                calendar.addEvent({
                                    title: eventTitle,
                                    // backgroundColor : '#63fff2',        // 색상 설정하는 방법
                                    start: arg.start,
                                    touristAttractionId:eventType,
                                    end: arg.end,
                                    allDay: arg.allDay,
                                    id: newId,
                                    type: eventType ? eventType : '',
                                    image: selectedAttraction ? selectedAttraction.imageUrl : '',
                                });

                                /* 생성된 계획을 DB에 저장하기 위한 코드 */
                                $.ajax({
                                    type: "POST",
                                    url: "/insertPlan",
                                    data: JSON.stringify({
                                        detailPlanId: newId,
                                        touristAttractionId:eventType,
                                        content: eventTitle,        // 내용
                                        price: newEventPrice,        // 내용
                                        planId: planID,
                                        startTime: arg.start,
                                        endTime: arg.end,
                                        allDay: arg.allDay,
                                    }), // 데이터를 JSON 형식으로 보냄
                                    contentType: "application/json; charset=UTF-8",
                                    dataType: "text",
                                    success: function (response) {
                                        const attraction = attractionData.find(attraction => attraction.touristAttractionId == eventType);

                                        if (attraction){
                                            detailData.push({
                                                id: newId,          // 새로 생성된 id
                                                title: eventTitle,   // 내용
                                                start: arg.start,
                                                end: arg.end,
                                                allDay: arg.allDay,
                                                touristAttractionId: eventType,

                                                label: eventType.toString(),
                                                name: attraction.name,
                                                lat: parseFloat(attraction.latitude),                 // 위도 (실수 형태로 변환필요)
                                                lng: parseFloat(attraction.longitude),                // 경도 (실수 형태로 변환필요)
                                                imageUrl: attraction.imageUrl.toString(),             // 이미지 경로
                                                address: attraction.address.toString(),               // 주소
                                                introduction: attraction.introduction.toString()      // 소개글
                                            });
                                        } else {
                                            detailData.push({
                                                id: newId,          // 새로 생성된 id
                                                title: eventTitle,   // 내용
                                                start: arg.start,
                                                end: arg.end,
                                                allDay: arg.allDay,
                                                touristAttractionId: eventType
                                            });
                                        }

                                        detailData.sort(function(a, b) {
                                            return new Date(a.start) - new Date(b.start);
                                        });

                                        updateMap(detailData);
                                    },
                                    error: function () {
                                        // 오류 처리
                                    }
                                });
                            }
                        },
                    }).then((result) => {
                        calendar.unselect();
                    });

                    const imagePreview = document.getElementById('image-preview');
                    const eventTypeSelect = document.getElementById('event-type');

                    /* 이미지를 변경할때 사용되는 부분 */
                    eventTypeSelect.addEventListener('change', function () {
                        const selectedValue = eventTypeSelect.value;
                        const selectedAttraction = attractionData.find((attraction) => attraction.touristAttractionId === selectedValue);

                        if (selectedAttraction) {
                            imagePreview.innerHTML = `<img src="${selectedAttraction.imageUrl}" alt="${selectedAttraction.name}"  class="modal-image" onerror="this.src=\'/pictures/base.jpg\';"/>`;
                        } else {
                            imagePreview.innerHTML = `<img src="/pictures/base.jpg" class="modal-image" onerror="this.src=\'/pictures/base.jpg\';"/>`;
                        }
                    });

                    function getSelectOptions(attractionData) {
                        let selectOptions = '<div><select id="event-type" class="swal2-select">';
                        attractionData.forEach((attraction) => {
                            selectOptions += `<option value="${attraction.touristAttractionId}">${attraction.name}</option>`;
                        });
                        selectOptions += '</select></div>';
                        return selectOptions;
                    }
                },
                eventClick: function (arg) {            // 이벤트를 클릭했을때
                    var eventId = arg.event.id;
                    // console.log(eventId);
                    var eventImage = arg.event.extendedProps.image;
                    openDialog(eventId, calendar);      // 수정창을 연다.
                },
                editable: true,
                dayMaxEvents: true,
                initialView: 'dayGridMonth',            // 초기 달력 상태 (dayGridMonth,timeGridWeek,timeGridDay)
                events: detailData,
                eventReceive: function (info) {         // 외부 객체를 Drag & Drop 했을 경우에 발생하는 EVENT
                    var newEvent = info.event;
                    var newId= generateEventId();

                    // console.log('before : ' + JSON.stringify(newEvent));

                    newEvent.setProp('id', newId);
                    // newEvent.setExtendedProp('touristAttractionId', info.event._def.extendedProps.touristAttractionId);

                    // console.log('before : ' + JSON.stringify(newEvent));

                    // const originalStart = new Date(newEvent.start);
                    // const modifiedStart = new Date(originalStart.getTime() - (9 * 60 * 60 * 1000));

                    const originalEnd = new Date(newEvent.end);
                    const modifiedEnd = new Date(originalEnd.getTime() - (9 * 60 * 60 * 1000));

                    // console.log(info);
                    $.ajax({            // DB에 저장하기 위해 실행될 AJAX문
                        type: "POST",
                        url: "/insertPlan",
                        data: JSON.stringify({
                            detailPlanId: newId,
                            touristAttractionId:newEvent.extendedProps.touristAttractionId,
                            content: newEvent.title,
                            startTime: newEvent.start,
                            planId: planID,
                            // endTime: modifiedEnd,
                            allDay: newEvent.allDay,
                        }), // 데이터를 JSON 형식으로 보냄
                        contentType: "application/json; charset=UTF-8",
                        dataType: "text",
                        success: function (response) {
                            const attraction = attractionData.find(attraction => attraction.touristAttractionId == newEvent.extendedProps.touristAttractionId);

                            if (attraction){
                                detailData.push({
                                    id: newId, // 새로 생성된 id
                                    title: newEvent.title,   // 내용
                                    start: newEvent.start,
                                    end: modifiedEnd,
                                    allDay: newEvent.allDay,
                                    touristAttractionId: newEvent.extendedProps.touristAttractionId,

                                    label: newEvent.extendedProps.touristAttractionId.toString(),
                                    name: attraction.name,
                                    lat: parseFloat(attraction.latitude),                 // 위도 (실수 형태로 변환필요)
                                    lng: parseFloat(attraction.longitude),                // 경도 (실수 형태로 변환필요)
                                    imageUrl: attraction.imageUrl.toString(),             // 이미지 경로
                                    address: attraction.address.toString(),               // 주소
                                    introduction: attraction.introduction.toString()      // 소개글
                                });
                            } else {
                                detailData.push({
                                    id: newId, // 새로 생성된 id
                                    title: newEvent.title,   // 내용
                                    start: newEvent.start,
                                    end: modifiedEnd,
                                    allDay: newEvent.allDay,
                                    touristAttractionId: newEvent.extendedProps.touristAttractionId
                                });
                            }
                            detailData.sort(function(a, b) {
                                return new Date(a.start) - new Date(b.start);
                            });

                            updateMap(detailData);
                        },
                        error: function () {
                            // 오류 처리
                        }
                    });

                },
                eventDrop : function(event){        // 이벤트를 놓았을때 작동
                    // alert(JSON.stringify(event.event));
                    //console.log(event.event.id);
                    $.ajax({
                        type: "POST",
                        url: "/insertPlan",
                        data: JSON.stringify({
                            detailPlanId:event.event.id,
                            planId: planID,
                            startTime: event.event.start,
                            endTime: event.event.end,
                            allDay: event.event.allDay,
                        }), // 데이터를 JSON 형식으로 보냄
                        contentType: "application/json; charset=UTF-8",
                        dataType: "text",
                        success: function (response) {
                            /* 수정작업이 완료되면 JS의 List정보 수정 */
                            var itemToUpdate = detailData.find(function (item) {
                                return item.id == event.event.id;
                            });

                            if (itemToUpdate) {
                                itemToUpdate.start = event.event.start;
                                itemToUpdate.end = event.event.end;

                            } else {
                                console.error("ID가 " + itemToUpdate + "인 항목을 찾을 수 없음.");
                            }
                            detailData.sort(function(a, b) {
                                return new Date(a.start) - new Date(b.start);
                            });

                            updateMap(detailData);
                        },
                        error: function () {
                            // 오류 처리
                        }
                    });

                },

                eventResize : function(event){        // 이벤트 길이 조절
                    $.ajax({
                        type: "POST",
                        url: "/insertPlan",
                        data: JSON.stringify({
                            detailPlanId:event.event.id,
                            planId: planID,
                            startTime: event.event.start,
                            endTime: event.event.end,
                        }), // 데이터를 JSON 형식으로 보냄
                        contentType: "application/json; charset=UTF-8",
                        dataType: "text",
                        success: function (response) {

                            /* 수정작업이 완료되면 JS의 List정보 수정 */
                            var itemToUpdate = detailData.find(function (item) {
                                return item.id == event.event.id;
                            });

                            if (itemToUpdate) {
                                itemToUpdate.start = event.event.start;
                                itemToUpdate.end = event.event.end;
                            } else {
                                console.error("ID가 " + itemToUpdate + "인 항목을 찾을 수 없음.");
                            }
                            detailData.sort(function(a, b) {
                                return new Date(a.start) - new Date(b.start);
                            });

                            updateMap(detailData);
                        },
                        error: function () {
                            // 오류 처리
                        }
                    });
                },

            });

            calendar.render();

            /************************************************/
            /* 작성된 계획을 클릭하여 수정 또는 삭제 작업을 위한 함수 */
            /************************************************/
            function openDialog(eventId, calendar) {
                const selectedPlan = detailData.find((plan) => plan.id == eventId);
                var selectedAttraction = null;
                if(selectedPlan.touristAttractionId == null){
                    selectedAttraction = 0;
                } else {
                    selectedAttraction = attractionData.find((attraction) => attraction.touristAttractionId == selectedPlan.touristAttractionId);
                }
                Swal.fire({
                    title: '일정 관리',
                    html: `
                            <div id="image-preview">
                                <img src="${selectedAttraction.imageUrl}" alt="Selected Image" class="modal-image" onerror="this.src='/pictures/base.jpg';">
                            </div>
                            ${getSelectOptions(attractionData, selectedAttraction.touristAttractionId)}
                            <div>
                                <span class="swal2-text-area">메모</span>
                                <span>
                                    <input id="event-title" class="swal2-input" value="${selectedPlan.title}" placeholder="계획을 입력하세요."/>
                                </span>
                            </div>
                            <div>
                                 <span class="swal2-text-area">비용</span>
                                 <span>
                                    <input id="event-price" class="swal2-input" type="number" value="${selectedPlan.price}" placeholder="예상 금액을 입력해주세요."/>
                                 </span>
                            </div>
                        `,
                    showCancelButton: true,
                    showDenyButton: true,
                    showCloseButton: true,
                    confirmButtonText: '수정',
                    denyButtonText: `삭제`,
                    cancelButtonText: '취소',
                    customClass: {
                        popup: 'custom-modal-width',
                    },
                    didOpen: () => {
                        const eventTypeSelect = document.getElementById('event-type');
                        const selectedImage = document.getElementById('selected-image');

                        /*eventTypeSelect.addEventListener('change', function () {
                            const selectedValue = eventTypeSelect.value;
                            const selectedAttraction = attractionData.find((attraction) => attraction.touristAttractionId === selectedValue);

                            if (selectedAttraction) {
                                selectedImage.src = selectedAttraction.imageUrl;
                            } else {
                                selectedImage.src = '/pictures/base.jpg'; // 선택된 이미지가 없을 경우 기본 이미지 표시
                            }
                        });*/
                    },
                    preConfirm: () => {
                        const newEventTitle = document.getElementById('event-title').value;
                        const newEventPrice = document.getElementById('event-price').value;
                        const selectedAttractionId = document.getElementById('event-type').value;
                        const selectedAttraction = attractionData.find((attraction) => attraction.touristAttractionId === selectedAttractionId);

                        if (!newEventTitle) {
                            Swal.showValidationMessage('계획 정보가 입력되지 않았습니다.');
                        } else {
                            // 수정된 이벤트 제목과 이미지를 적용
                            const event = calendar.getEventById(eventId);

                            event.setProp('title', newEventTitle);
                            event.setExtendedProp('image', selectedAttraction ? selectedAttraction.imageUrl : '');

                            calendar.refetchEvents();

                            /* 수정 */
                            $.ajax({
                                type: "POST",
                                url: "/insertPlan",
                                data: JSON.stringify({
                                    detailPlanId:eventId,
                                    planId: planID,
                                    touristAttractionId:selectedAttractionId,
                                    content: newEventTitle, // 내용
                                    price: newEventPrice, // 금액
                                }), // 데이터를 JSON 형식으로 보냄
                                contentType: "application/json; charset=UTF-8",
                                dataType: "text",
                                success: function (response) {

                                    /* 수정작업이 완료되면 JS의 List정보 수정 */
                                    var itemToUpdate = detailData.find(item => item.id == eventId);

                                    // console.log(itemToUpdate);

                                    if (itemToUpdate) {
                                        itemToUpdate.title = newEventTitle;
                                        itemToUpdate.price = newEventPrice;
                                        itemToUpdate.touristAttractionId = selectedAttractionId;
                                        itemToUpdate.lat = selectedAttraction.latitude;
                                        itemToUpdate.lng = selectedAttraction.longitude;
                                    } else {
                                        console.error("ID가 " + itemToUpdate + "인 항목을 찾을 수 없음.");
                                    }

                                    // console.log(itemToUpdate);


                                    detailData.sort(function(a, b) {
                                        return new Date(a.start) - new Date(b.start);
                                    });

                                    updateMap(detailData);
                                },
                                error: function () {
                                    // 오류 처리
                                }
                            });
                        }
                    },
                }).then((result) => {
                    if (result.isConfirmed) {
                        // 수정 버튼 클릭 시
                        // 수정 로직이 이미 preConfirm 함수에서 처리되었으므로 따로 처리할 내용은 없습니다.
                    } else if (result.dismiss === Swal.DismissReason.isDenied) {
                        // 삭제 버튼 클릭 시, 이벤트 삭제
                        const event = calendar.getEventById(eventId);
                        // alert(JSON.stringify(event));
                        event.remove();

                        $.ajax({
                            type: "POST",
                            url: "/deletePlan",
                            data: {
                                detailPlanId:eventId,
                                planId: planID,
                            }, // 데이터를 JSON 형식으로 보냄
                            success: function (response) {
                                var indexToDelete = detailData.findIndex(function (item) {
                                    return item.id == eventId;
                                });
                                if (indexToDelete !== -1) {
                                    // 아이템 삭제
                                    detailData.splice(indexToDelete, 1);
                                } else {
                                    console.error("ID가 " + eventId + "인 항목을 찾을 수 없음.");
                                }
                                detailData.sort(function(a, b) {
                                    return new Date(a.start) - new Date(b.start);
                                });

                                updateMap(detailData);
                            },
                            error: function () {
                                // 오류 처리
                            }
                        });

                    }
                });

                const imagePreview = document.getElementById('image-preview');
                const eventTypeSelect = document.getElementById('event-type');


                eventTypeSelect.addEventListener('change', function () {
                    const selectedValue = eventTypeSelect.value;
                    const selectedAttraction = attractionData.find((attraction) => attraction.touristAttractionId === selectedValue);

                    if (selectedAttraction) {
                        imagePreview.innerHTML = `<img src="${selectedAttraction.imageUrl}" alt="${selectedAttraction.name}" class="modal-image" onerror="this.src='/pictures/base.jpg';"/>`;
                    } else {
                        imagePreview.innerHTML = `<img src="/pictures/base.jpg" class="modal-image" onerror="this.src='/pictures/base.jpg';"/>`;
                    }
                });

                function getSelectOptions(attractionData, attrationId) {
                    let selectOptions = '<div><select id="event-type" class="swal2-select">';
                    attractionData.forEach((attraction) => {
                        selectOptions += `<option value="${attraction.touristAttractionId}"${attrationId === attraction.touristAttractionId ? ' selected' : ''}>${attraction.name}</option>`;
                    });
                    selectOptions += '</select></div>';
                    return selectOptions;
                }
            }

            // updateMap(detailData);
            document.getElementById('custom-startDate-button').addEventListener('click', function() {
                var startDateElement = document.getElementById('startDate');

                var customDate = startDateElement.getAttribute("data-variable");
                calendar.gotoDate(customDate);
            });
        });

        window.initMap = function () {

            const bounds = new google.maps.LatLngBounds();
            const infoWindow = new google.maps.InfoWindow();
            const markers = [];
            const attracionMarkers = [];

            var detailList = document.getElementById('detailList').getAttribute('data-variable');

            var jsonDetailList = JSON.parse(detailList);

            var attractionList = document.getElementById('attractionList').getAttribute('data-variable');
            // JSON 타입으로 변환한다. (String의 형식이 JSON형식이여야지 가능하다.)
            var jsonAttractionList = JSON.parse(attractionList);


            /* 관광지를 선택하지 않았을 경우를 대비하기 위해서 임의로 작성 */
            attractionData.push({
                touristAttractionId : 0,
                address : '',
                name : '선택하지 않음',
                imageUrl : 'https://github.com/hwet-j/rego/assets/125880480/20c539ee-6568-468e-919d-3ed42cb6c56a',
                introduction : '',
                latitude : '',
                longitude : '',
                contentType : '',
                cityName : ''
            });


            /* 관광지 정보를 관광지ID 값으로 검색하기 위해 객체 생성 - 관광지 목록 변수에 저장 */
            jsonAttractionList.forEach(function (attraction) {
                attractionData.push({
                    touristAttractionId : attraction.touristAttractionId.toString(),
                    address : attraction.address.toString(),
                    name : attraction.name.toString(),
                    imageUrl : attraction.image.toString(),
                    introduction : attraction.introduction.toString(),
                    latitude : parseFloat(attraction.latitude),
                    longitude : parseFloat(attraction.longitude),
                    contentType : attraction.contentType.toString(),
                    cityName : attraction.cityName.toString()
                });
            });
            /* DB에 있는 정보를 캘린더에 출력하기 위한 객체 - 상세 일정 변수에 저장 */
            jsonDetailList.forEach(function (detail) {
                const attraction = attractionData.find(attraction => attraction.touristAttractionId == detail.touristAttractionId);

                if (attraction){
                    detailData.push({
                        id:detail.detailPlanId,
                        title: detail.content.toString(),
                        start: detail.startTime,
                        end: detail.endTime,
                        allDay: detail.allDay,
                        touristAttractionId:detail.touristAttractionId,
                        price:detail.price,

                        label: detail.touristAttractionId.toString(),
                        name: attraction.name,
                        lat: parseFloat(attraction.latitude),                 // 위도 (실수 형태로 변환필요)
                        lng: parseFloat(attraction.longitude),                // 경도 (실수 형태로 변환필요)
                        imageUrl: attraction.imageUrl.toString(),             // 이미지 경로
                        address: attraction.address.toString(),               // 주소
                        introduction: attraction.introduction.toString()      // 소개글
                    });
                } else {
                    detailData.push({
                        id: detail.detailPlanId,
                        title: detail.content.toString(),
                        start: detail.startTime,
                        end: detail.endTime,
                        allDay: detail.allDay,
                        touristAttractionId: detail.touristAttractionId,
                        price:detail.price,
                    });
                }
                console.log(detail.price);
            });

            detailData.sort(function(a, b) {
                return new Date(a.start) - new Date(b.start);
            });


            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 37.58667, lng: 126.97611 },
                zoom: 12,
                minZoom: 3,
                maxZoom: 27,
                mapTypeControl: false,
                fullscreenControl: false,
            });

            // console.log("지도지도지도");
            updateMap(detailData);

            // 관광지 정보 마커 표시
            attractionMarker(attractionData);

            const attdata = detailData.filter(item => typeof item.lat === 'number' && typeof item.lng === 'number' && !isNaN(item.lat));

            var boundss = new google.maps.LatLngBounds();
            for(var i=0; i < attdata.length; i++){
                boundss.extend(new google.maps.LatLng(attdata[i].lat, attdata[i].lng));
            }

            map.fitBounds(boundss);

            function updateMap(originDetailData) {
                // 이전 마커 및 선 삭제 로직 (생략)
                markers.forEach(({ marker }) => {
                    marker.setMap(null);
                });

                countMarker = 0;

                const data = originDetailData.filter(item => typeof item.lat === 'number' && typeof item.lng === 'number' && !isNaN(item.lat));

                // console.log(data);

                /* 빨강색 마커 생성하기 위한 작업 */
                data.forEach(({ label, name, lat, lng, imageUrl, introduction , title}) => {

                    countMarker += 1;

                    const marker = new google.maps.Marker({
                        position: { lat, lng },
                        // label:'-',
                        map,
                        icon: {
                            url:'https://github.com/hwet-j/rego/assets/125880480/9eb403a9-316e-4a59-a2c5-8a176db74575',
                            scaledSize: new google.maps.Size(25, 40),
                        },
                        zIndex:1000,
                    });

                    bounds.extend(marker.position);

                    marker.addListener('click', () => {
                        map.panTo(marker.position);

                        const content = document.createElement('div');

                        const image = document.createElement('img');
                        image.src = imageUrl;
                        image.alt = name;
                        image.width = 200;
                        content.appendChild(image);

                        const subject = document.createElement('p');
                        subject.textContent = name;
                        content.appendChild(subject);

                        const title_p = document.createElement('p');
                        title_p.textContent = title;
                        content.appendChild(title_p);


                        const button = document.createElement('button');
                        button.textContent = '관광지정보';
                        button.addEventListener('click', () => {
                            Swal.fire({
                                title: `${name}`,
                                text: `${introduction}`,
                                imageUrl: `${imageUrl}`,
                                imageWidth: 800,
                                imageHeight: 600,
                                customClass: {
                                    popup: 'custom-modal-width2',
                                },
                            });
                        });
                        content.appendChild(button);

                        infoWindow.setContent(content);
                        infoWindow.open(map, marker);

                    });

                    markers.push({ label, name, marker });
                });


                map.fitBounds(bounds);

                // 선 그리기 함수 호출

                drawPolyline(map, data);

                function drawPolyline(map, originDetailData) {

                    const data = originDetailData.filter(item => typeof item.lat === 'number' && typeof item.lng === 'number' && !isNaN(item.lat));

                    /* 아이콘은 최초 1회만 생성되어야 하므로 최초생성 시 0에서 1로변환 */
                    if (markerMake == 0 && countMarker > 1) {
                        markerMake = 1;

                        /* 아이콘 생성 */
                        iconMarker = new google.maps.Marker({
                            map: map,
                            animation: google.maps.Animation.BOUNCE,
                            icon: {
                                url: "https://github.com/hwet-j/hwet-j.github.io/assets/81364742/ef2f4530-9c23-4b1c-aae7-8054e46bd2a7",
                                scaledSize: new google.maps.Size(40, 40),
                                origin: new google.maps.Point(0, 0),
                                anchor: new google.maps.Point(15, 15)
                            }
                        });

                        var index = 0;                 // 마커의 위치
                        var distanceToTravel = 0.001;    // 고정된 이동 거리
                        var speed = 30;                 // 마커 이동 속도

                        /* 화살표 형식으로 선긋기 */
                        for (var i = 0; i < data.length - 1; i++) {
                            var start = data[i];
                            var end = data[i + 1];

                            var lineSymbol = {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, // 화살표 모양
                                scale: 3,               // 화살표 크기
                                strokeColor: "black" // 화살표의 색상
                            };


                            /* 이 기능을 활용하면 이동방식에 따른 항공,기차 등을 구현 가능할듯함 */
                            var line = new google.maps.Polyline({
                                path: [start, end],
                                icons: [
                                    {
                                        icon: lineSymbol,
                                        offset: "100%" // 화살표 위치 (끝)
                                    }
                                ],
                                strokeColor: "black", // 선의 색상
                                strokeOpacity: 1.0,     // 선의 불투명도 (0.0 - 1.0)
                                strokeWeight: 2,        // 선의 두께
                                map: map
                            });

                            previousPolylines.push(line);

                        }


                    } else if (countMarker > 1){
                        clearPreviousPolylines();

                        for (var i = 0; i < data.length - 1; i++) {
                            var start = data[i];
                            var end = data[i + 1];

                            var lineSymbol = {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, // 화살표 모양
                                scale: 3, // 화살표 크기
                                strokeColor: "#9900ff" // 화살표의 색상
                            };

                            /* 이 기능을 활용하면 이동방식에 따른 항공,기차 등을 구현 가능할듯함 */
                            var line = new google.maps.Polyline({
                                path: [start, end],
                                icons: [
                                    {
                                        icon: lineSymbol,
                                        offset: "100%" // 화살표 위치 (끝)
                                    }
                                ],
                                strokeColor: "#002aff", // 선의 색상
                                strokeOpacity: 1.0,     // 선의 불투명도 (0.0 - 1.0)
                                strokeWeight: 2,        // 선의 두께
                                map: map
                            });

                            previousPolylines.push(line);
                        }
                    } else {
                        clearPreviousPolylines();
                        if (iconMarker){
                            if (countMarker != 0){
                                iconMarker.setMap(null);
                            }
                        }

                        markerMake = 0;
                    }


                }

                var boundss = new google.maps.LatLngBounds();
                for(var i=0; i < data.length; i++){
                    boundss.extend(new google.maps.LatLng(data[i].lat, data[i].lng));
                }
                map.fitBounds(boundss);
            }

            function attractionMarker(attractionOriginData) {
                // 이전 마커 및 선 삭제 로직 (생략)
                attracionMarkers.forEach(({ atmarker }) => {
                    atmarker.setMap(null);
                });

                // console.log(attractionOriginData);

                const atdata = attractionOriginData.filter(item => typeof item.latitude === 'number' && typeof item.longitude === 'number' && !isNaN(item.latitude));
                //console.log(atdata);
                /* 빨강색 마커 생성하기 위한 작업 */
                atdata.forEach(({ touristAttractionId, name, latitude, longitude, imageUrl, introduction }) => {

                    // console.log(touristAttractionId, name, latitude, longitude, imageUrl, introduction)

                    const atmarker = new google.maps.Marker({
                        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
                        // label:'관',
                        map:map,
                        icon: {
                            url: 'https://github.com/hwet-j/hwet-j.github.io/assets/81364742/5d381fdd-ed36-48ff-9cfa-58b1536d5d49',
                            scaledSize: new google.maps.Size(22, 22), // 아이콘 크기 설정
                        },
                        zIndex:10,
                    });

                    bounds.extend(atmarker.position);

                    atmarker.addListener('click', () => {
                        map.panTo(atmarker.position);

                        const content = document.createElement('div');

                        const image = document.createElement('img');
                        image.src = imageUrl;
                        image.alt = name;
                        image.width = 200;
                        content.appendChild(image);

                        const title = document.createElement('p');
                        title.textContent = name;
                        content.appendChild(title);

                        const button = document.createElement('button');
                        button.textContent = '관광지정보';
                        button.addEventListener('click', () => {
                            Swal.fire({
                                title: `${name}`,
                                text: `${introduction}`,
                                imageUrl: `${imageUrl}`,
                                imageWidth: 600,
                                imageHeight: 450,

                                customClass: {
                                    popup: 'custom-modal-width2',
                                },
                            });
                        });
                        content.appendChild(button);

                        infoWindow.setContent(content);
                        infoWindow.open(map, atmarker);
                    });

                    attracionMarkers.push({ touristAttractionId, name, atmarker });
                });


                map.fitBounds(bounds);

                /* 검색기능 사용시 비슷한 문자를 찾아 검색 */
                function calculateSimilarity(query, name) {
                    const queryLower = query.toLowerCase();
                    const nameLower = name.toLowerCase();
                    let similarity = false;

                    // 간단한 유사성 평가 방법으로 문자열에서 공백을 제거하고, 검색어가 이름에 포함되어 있는지 확인합니다.
                    if (/^[가-힣]+$/.test(query)) {
                        const normalizedQuery = queryLower.replace(/[^가-힣]/g, "");
                        const normalizedName = nameLower.replace(/[^가-힣]/g, "");
                        similarity = normalizedName.includes(normalizedQuery);
                    } else {
                        const normalizedQuery = queryLower.replace(/[^a-z]/g, "");
                        const normalizedName = nameLower.replace(/[^a-z]/g, "");
                        similarity = normalizedName.includes(normalizedQuery);
                    }
                    return similarity;
                }



                /* 검색 기능 추가 */
                const searchInput = document.getElementById("searchInput");
                const searchButton = document.getElementById("searchButton");

                // Enter 키 누를 때 검색 함수 호출
                searchInput.addEventListener("keyup", function(event) {
                    if (event.key === "Enter") {
                        const query = searchInput.value.trim();
                        if (query) {
                            searchResultsElement.style.display = "block";
                            cancelButton.style.display = "block";
                            handleSearch(query);
                        }
                    }
                });

                // 검색 버튼 클릭 이벤트 처리
                searchButton.addEventListener("click", () => {
                    const query = searchInput.value.trim();
                    if (query) {
                        handleSearch(query);
                    }
                });

                const cancelButton = document.getElementById("cancelButton");
                const searchResultsElement = document.getElementById("searchResults");

                searchButton.addEventListener("click", function () {
                    // 검색 버튼 클릭 시 검색 결과를 보이도록 설정
                    searchResultsElement.style.display = "block";
                    cancelButton.style.display = "block";

                    // 검색 결과를 처리하고 표시하는 함수 호출
                    handleSearch(searchInput.value);
                });

                cancelButton.addEventListener("click", function () {
                    // 검색 취소 버튼 클릭 시 검색 결과를 숨김
                    searchResultsElement.style.display = "none";
                    cancelButton.style.display = "none";
                });

                function handleSearch(query) {
                    const results = [];

                    atdata.forEach(({ touristAttractionId, name, latitude, longitude, imageUrl }) => {
                        // 검색어와 이름 간의 유사성을 계산
                        if (calculateSimilarity(query, name)) {
                            results.push({ touristAttractionId, name, latitude, longitude, imageUrl });
                        }
                    });

                    const searchResultsElement = document.getElementById("searchResults");
                    searchResultsElement.innerHTML = ""; // 검색 결과 초기화

                    if (results.length > 0) {
                        results.forEach(({ touristAttractionId, name, latitude, longitude, imageUrl }) => {
                            const listItem = document.createElement("li");
                            listItem.innerHTML = `
                                          <a href="#" data-lat="${latitude}" data-lng="${longitude}">
                                            <img src="${imageUrl}" alt="${name}" width="40">
                                            ${name}
                                          </a>
                                        `;
                            searchResultsElement.appendChild(listItem);

                            // 검색 결과 항목을 클릭했을 때 지도 이동 및 정보 표시
                            listItem.querySelector("a").addEventListener("click", (e) => {
                                e.preventDefault();
                                const clickedLat = parseFloat(e.target.getAttribute("data-lat"));
                                const clickedLng = parseFloat(e.target.getAttribute("data-lng"));
                                const resultMarker = attracionMarkers.find((marker) => marker.touristAttractionId === touristAttractionId);

                                if (resultMarker) {
                                    const { atmarker } = resultMarker;
                                    map.panTo({ lat: clickedLat, lng: clickedLng });
                                    google.maps.event.trigger(atmarker, "click");
                                }
                            });
                        });
                    } else {
                        searchResultsElement.innerHTML = "<li>검색된 장소가 없습니다.</li>";
                    }
                }

            }

            /* updateMap를 전역변수로 변경 */
            window.updateMap = updateMap;
            window.attractionMarker = attractionMarker;

        };

        var previousPolylines = [];

        // 이전 선을 모두 제거하는 함수를 정의합니다.
        function clearPreviousPolylines() {
            previousPolylines.forEach(function (polyline) {
                polyline.setMap(null);          // 이전 선을 지도에서 제거
            });
            previousPolylines = []; // 배열 초기화
        }

    </script>



    <script>
        <!-- 관광지를 도시별로 검색 -->
        document.addEventListener("DOMContentLoaded", function () {
            var searchSelect = document.getElementById("searchSelect");
            var externalEventsList = document.getElementById("external-events-list");
            var contentTypeButtons = document.querySelectorAll(".content-type-button");

            // 선택된 contentType 값을 초기화
            var selectedContentType = "";

            // 각 contentType 버튼에 대한 클릭 이벤트 리스너 등록
            contentTypeButtons.forEach(function (button) {
                button.addEventListener("click", function () {
                    selectedContentType = button.getAttribute("data-content-type");
                    // 버튼을 클릭할 때 선택된 contentType 값을 저장
                    fetchData(); // 버튼 클릭 시 데이터 가져오는 함수 호출
                });
            });

            // 페이지 로딩 시 자동으로 데이터를 가져오도록 함수 호출
            fetchData();

            // 데이터를 가져와서 external-events 업데이트하는 함수
            function fetchData() {
                var selectedKeyword = searchSelect.value; // 선택된 검색어 가져오기

                // 서버로 선택된 검색어와 contentType 값을 전송하고 결과를 받아올 수 있는 AJAX 요청 보내기
                $.ajax({
                    url: '/selectAttraction?keyword=' + selectedKeyword + '&contentType=' + selectedContentType, // 서버의 URL
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        // 받아온 JSON 데이터를 사용하여 external-events 업데이트
                        externalEventsList.innerHTML = ""; // 기존 목록 비우기

                        for (var i = 0; i < data.length; i++) {
                            var attraction = data[i];
                            // external-events를 업데이트하는 로직을 작성
                            var eventHtml = '<div class="fc-event-container" data-image="' + attraction.image + '" ' +
                                'data-title="' + attraction.name + '">' +
                                '<div class="image-container"><img class="attraction-image" src="' + attraction.image + '">' +
                                '<div style="text-align: center;">' + attraction.name + '</div>' +
                                '</div></div>';

                            var draggableEl = document.createElement('div');
                            draggableEl.innerHTML = eventHtml;
                            externalEventsList.appendChild(draggableEl);

                            // 드래그 가능한 외부 이벤트로 만들기
                            var draggableEvent = new FullCalendar.Draggable(draggableEl, {
                                eventData: {
                                    title: attraction.name,
                                    image: attraction.image,
                                    touristAttractionId: attraction.touristAttractionId,
                                }
                            });
                        }
                    },
                    error: function () {
                        console.error('데이터를 가져오는 중에 오류가 발생했습니다.');
                    }
                });
            }
        });
        function formatMoney(inputElement) {
            // Get the numeric value from the input element
            const numericValue = parseFloat(inputElement.value);

            // Check if the input is a valid number
            if (!isNaN(numericValue)) {
                // Format the numeric value as currency (Korean Won)
                const moneyFormatted = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(numericValue);

                // Set the formatted value back to the input element
                inputElement.value = moneyFormatted;
            }
        }


    </script>


    <script>
        //ajax를 통한 날짜수정 시작
        document.addEventListener('DOMContentLoaded', function() {

            // JavaScript code for handling the button click
            var modifyButton = document.getElementById('modifyButton');
            if (modifyButton) {
                modifyButton.addEventListener('click', function() {
                    var defaultStartDate = document.getElementById('startDateElement').textContent;
                    var defaultEndDate = document.getElementById('endDateElement').textContent;

                    var datePlanId = document.getElementById('planID').getAttribute('data-variable');

                    var content = document.getElementById('content').getAttribute('data-variable');
                    var type = document.getElementById('type').getAttribute('data-variable');
                    var numberOfPeople = document.getElementById('numberOfPeople').getAttribute('data-variable');

                    Swal.fire({
                        title: '날짜 선택',
                        html: `
                            <div>검색 유형 <select class="form-control" id="editSearchType" name="type">
                            <option value="">미선택</option>
                            <option value="자유" ${type === "자유" ? "selected" : ""}>자유</option>
                            <option value="힐링" ${type === "힐링" ? "selected" : ""}>힐링</option>
                            <option value="문화" ${type === "문화" ? "selected" : ""}>문화</option>
                            <option value="쇼핑" ${type === "쇼핑" ? "selected" : ""}>쇼핑</option>
                            <option value="식도락" ${type === "식도락" ? "selected" : ""}>식도락</option>
                            </select></div>
                            <div>여행 제목 <input class="input-content" id="editContent" name="content" type="text" value="${content}"></div>
                            <div>시작일 <input type="date" id="editStartDate" value="${defaultStartDate}" ></div>
                            <div>종료일 <input type="date" id="editEndDate" value="${defaultEndDate}"></div>
                            <div>여행 인원 <input class="input-content" id="editNumberOfPeople" value="${numberOfPeople}" name="numberOfPeople" type="number"></div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: '확인',
                        cancelButtonText: '취소',
                        preConfirm: () => {
                            var editSearchType = document.getElementById('editSearchType').value;
                            var editContent = document.getElementById('editContent').value;
                            var editStartDate = document.getElementById('editStartDate').value;
                            var editEndDate = document.getElementById('editEndDate').value;
                            var editNumberOfPeople = document.getElementById('editNumberOfPeople').value;
                            if (editEndDate < editStartDate) {
                                Swal.showValidationMessage('종료일은 시작일보다 늦을 수 없습니다.');
                            } else {
                                var editUrl = '/plan/dateEdit';

                                $.ajax({
                                    url: editUrl,
                                    type: 'POST', // 요청 방식을 POST로 변경
                                    data: {
                                        type: editSearchType,
                                        content: editContent,
                                        start: editStartDate,
                                        end: editEndDate,
                                        numberOfPeople: editNumberOfPeople,
                                        planId:datePlanId
                                    },
                                    success: function (data) {
                                            location.reload();
                                    },
                                    error: function () {
                                        console.error('데이터를 가져오는 중에 오류가 발생했습니다.');
                                    }
                                });

                            }
                        }
                    });
                });
            }
        });
        //ajax를 통한 날짜수정 끝
    </script>



    <style>

    </style>
</head>
<body>



<div class="background"></div>
<div class="background2"></div>

<span id="detailList" th:data-variable="${detailPlan}"></span>
<span id="attractionList" th:data-variable="${attractionList}"></span>
<span id="detailIdMax" th:data-variable="${detailIdMax}"></span>
<span id="planID" th:data-variable="${planID}"></span>
<span id="startDate" th:data-variable="${startDate}"></span>

<span id="content" th:data-variable="${content}"></span>
<span id="type" th:data-variable="${type}"></span>
<span id="numberOfPeople" th:data-variable="${numberOfPeople}"></span>

<div class="container">

    <div class="nav">
        <ul class="" style="list-style-type:none;">
            <li class="">
                <a class="logo" th:href="@{/}"><img src="/img/logo.png" style="float: left; width: 63px; height: 58px; margin-left: 10px; background-repeat: no-repeat;"></a>
                <div class="nav-left"
                     style="float:left;   margin-left: 440px; margin-top: 19px;  font-size: 20px;  font-family: 'Roboto', sans-serif; font-weight: 500;">
                    <a class="" style="margin-right: 50px; color:#4F54B4;"
                       th:href="@{/flightResult}">AIRPORT</a>
                    <a class="" style="margin-right: 50px; color:#4F54B4;"
                       th:href="@{/plan/add}">START PLAN</a>
                    <a class="" style="margin-right: 50px; color:#4F54B4;"
                       th:href="@{/touristAttraction/list}">ATTRACTIONS</a>
                    <a class="" style="color:#4F54B4;"
                       th:href="@{/plan/list}">PLAN LIST</a>
                </div>

                <div class="nav-right"
                     style="float:right;    margin-right: 35px; margin-top: 27px;  font-size: 12px;  font-family: 'Roboto', sans-serif; font-weight: 600;">
                    <a class="" style="margin-right: 20px; color:#4F54B4;"
                       th:href="@{/notice/list}">공지사항</a>
                    <a class="" style="margin-right: 20px; color:#4F54B4;"
                       th:href="@{/question/list}">고객센터</a>
                    <a class="loginBtn" sec:authorize="isAnonymous()" style="margin-right: 20px; color:#4F54B4;"
                       th:href="@{/login}">로그인</a>
                    <a class="" sec:authorize="isAuthenticated()" style="margin-right: 20px; color:#4F54B4;"
                       th:href="@{/myPage}">마이페이지</a>
                    <a class="" sec:authorize="isAuthenticated()" style="margin-right: 20px; color:#4F54B4;"
                       th:href="@{/logout}">로그아웃</a>
                    <a class="" sec:authorize="hasRole('ADMIN')" style="color:#4F54B4;"
                       th:href="@{/user/list}">ADMIN</a>
                </div>
            </li>
        </ul>
    </div>

    <div class="contain" style="display: flex;">
        <div id="map-container" style="position: relative;">
            <!-- 검색창 -->
            <input id="searchInput" placeholder="장소 검색" style="position: absolute; top: 10px; left: 10px; z-index: 1;"
                   type="text">
            <button id="searchButton" style="position: absolute; top: 10px; left: 190px; z-index: 1;">검색</button>
            <button id="cancelButton" style="position: absolute; top: 10px; left: 240px; z-index: 1; display: none;">검색 취소
            </button>
            <ul id="searchResults" style="position: absolute; top: 50px; left: 10px; z-index: 1; display: none;"></ul>
            <!-- 지도 -->
            <div id="map"></div>

            <a th:href="@{/plan/Preview(planId=${planID})}">
                <div class="preview-button">
                </div>
            </a>
            <div class="start-end-date">
                <div>
                    <span>시작일 : </span>
                    <span id="startDateElement" th:text="${startDate}"></span>

                    <button id="modifyButton">수정</button>
                </div>
                <div>
                    <span>종료일 : </span>
                    <span id="endDateElement" th:text="${endDate}"></span>
                </div>
            </div>
        </div>

        <div id='acalendar-wrp' style="position: relative;">
            <div id='calendar'>
                <!-- 캘린더 내용 -->
            </div>
            <!-- 버튼을 캘린더 내부에 배치 -->
            <button class="custom-startDate-button" id="custom-startDate-button" >Start Date</button>
        </div>
    </div>





    <!--<div id="searchResult"></div>-->

    <div id='wrap'>

        <div class="content-button-container">
            <select id="searchSelect">
                <option th:text="'전체'" value="">전체</option>
                <option th:each="city : ${cityList}"
                        th:text="${city}"
                        th:value="${city}">
                </option>
            </select>
            <button class="content-type-button" data-content-type="관광지" id="tourAttraction">관광지</button>
            <button class="content-type-button" data-content-type="식당" id="restaurant">식당</button>
            <button class="content-type-button" data-content-type="호텔" id="hotel">찜목록</button>
        </div>

        <div id='external-events'>
            <div id='external-events-list'>
            </div>
        </div>
    </div>
        <div class="buttonBox">
            <a class="savebtn" href="/" th:text="임시저장"></a>
            <a class="savebtn" th:href="@{/plan/Complete(planId=${planID})}" th:text="저장"></a>
        </div>
</div>
<script>
    const wrap = document.getElementById('external-events-list');

    wrap.addEventListener('wheel', (e) => {
        wrap.scrollLeft += e.deltaY; // 좌우 스크롤
        e.preventDefault(); // 스크롤 이벤트의 기본 동작을 중지
    });
</script>
</body>
</html>